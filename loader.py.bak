#!/usr/bin/env python3
"""
全库引入者·智能版 —— 自动扫描并导入所有组件模块。
新增任何 .py 文件，重启程序即自动注册。
"""

import os
import sys
import importlib.util
from pathlib import Path

# 要扫描的顶层包名列表
PACKAGES = ['sources', 'algorithms', 'uis', 'exporters', 'processors']

def import_module_from_file(py_file: Path, package_name: str):
    """动态导入单个 .py 文件作为模块"""
    module_name = f"{package_name}.{py_file.stem}"
    spec = importlib.util.spec_from_file_location(module_name, py_file)
    if spec and spec.loader:
        module = importlib.util.module_from_spec(spec)
        spec.loader.exec_module(module)
        sys.modules[module_name] = module
        return True
    return False

def scan_and_import():
    """扫描所有指定包目录，导入每个 .py 文件（非 __init__）"""
    root_dir = Path(__file__).parent   # loader.py 所在目录即项目根目录
    imported = []
    
    for pkg in PACKAGES:
        pkg_dir = root_dir / pkg
        if not pkg_dir.exists():
            continue
        
        # 递归扫描所有 .py 文件
        for py_file in pkg_dir.rglob("*.py"):
            if py_file.name == "__init__.py":
                continue
            try:
                if import_module_from_file(py_file, pkg):
                    imported.append(f"{pkg}.{py_file.stem}")
            except Exception as e:
                print(f"⚠️ 导入失败 {py_file.name}: {e}")
    
    return imported

# ========== 执行自动扫描导入 ==========
loaded_modules = scan_and_import()
print(f"✅ 全库智能加载完成，已注册 {len(loaded_modules)} 个组件")
# 可选：打印详细列表
# for mod in sorted(loaded_modules):
#     print(f"   - {mod}")